<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PhotoShoot Pro V5</title>
    <style>
        :root { 
            --primary: #6366f1; 
            --accent-red: #ff4d4d; 
            --bg: #0f172a; 
            --surface: #1e293b; 
            --text: #f8fafc; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', system-ui, sans-serif; 
            background: var(--bg); color: var(--text);
            display: flex; flex-direction: column; 
            margin: 0; 
            height: 100dvh; /* FIXED: Accounts for mobile address bars */
            width: 100vw; 
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            padding: 12px 20px; 
            background: rgba(15, 23, 42, 0.95);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            z-index: 100;
        }
        .brand { display: flex; align-items: center; gap: 6px; }
        .logo-svg { width: 24px; height: 24px; color: #fff; }
        .brand-name { 
            font-weight: 800; 
            letter-spacing: -0.8px; /* Tight branding */
            font-size: 1.2rem; 
        }
        .brand-name span { color: var(--accent-red); }

        #saveBtn {
            padding: 6px 16px; 
            font-size: 0.85rem; 
            border-radius: 6px;
            /* Pushes button away from text */
            margin-left: auto; 
        }

        /* --- VIEWPORT --- */
        main {
            flex: 1; 
            position: relative; 
            width: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; /* Start at top for scrolling */
            background: #000; 
            overflow-y: auto; /* Allows scrolling tall images */
            overflow-x: hidden;
        }

        .upload-zone {
            align-self: center;
            width: 85%; max-width: 400px; border: 2px dashed #475569;
            border-radius: 16px; padding: 50px 20px; text-align: center;
            background: var(--surface); cursor: pointer;
        }

        .canvas-container {
            position: relative; display: none; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8); 
            touch-action: none;
            cursor: none;
            margin-top: 20px;
            margin-bottom: 40px;
        }

        canvas { display: block; }
        #maskC { position: absolute; top: 0; left: 0; opacity: 0.6; pointer-events: auto; }

        /* --- UI ELEMENTS --- */
        #brushCursor {
            position: fixed; pointer-events: none; border: 2px solid #fff;
            border-radius: 50%; transform: translate(-50%, -50%); 
            z-index: 9999; display: none;
            box-shadow: 0 0 0 1px #000; backdrop-filter: invert(0.3);
        }

        .icon-png { width: 20px; height: 20px; object-fit: contain; display: block; margin: auto; }
        .icon-large { width: 48px; height: 48px; margin-bottom: 15px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }

        .toolbar {
            background: rgba(15, 23, 42, 0.98); 
            padding: 15px 20px 35px;
            display: none; flex-direction: column; gap: 15px;
            border-top: 1px solid rgba(255,255,255,0.1); 
            backdrop-filter: blur(20px);
        }

        .tools-row { display: flex; gap: 20px; align-items: center; }
        .slider-group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 0.7rem; color: #94a3b8; font-weight: 600; }
        input[type="range"] { width: 100%; accent-color: var(--primary); }

        .btn-group { display: flex; gap: 8px; width: 100%; }
        button {
            flex: 1; border: none; padding: 12px; border-radius: 10px;
            font-weight: 700; cursor: pointer; transition: 0.2s; color: white;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); }
        .btn-sec { background: #334155; }
        .btn-danger { background: #b91c1c; }
        .btn-icon { flex: 0 0 52px; }

        #loader {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .spinner { width: 45px; height: 45px; border: 4px solid #334155; border-top-color: var(--accent-red); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <svg class="logo-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </svg>
            <div class="brand-name">Photo<span>Shoot</span></div>
        </div>
        <button class="btn-primary" id="saveBtn">Save</button>
    </header>

    <main id="viewport">
        <label class="upload-zone" id="dropZone">
            <input type="file" id="upload" accept="image/*" style="display:none">
            <img src="https://img.icons8.com/ios-filled/100/ffffff/image.png" class="icon-png icon-large" alt="upload">
            <strong>Tap to Upload Image</strong>
            <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 8px; letter-spacing: 0.5px; font-weight: 500;">FOR FREE</div>
        </label>

        <div class="canvas-container" id="wrap">
            <canvas id="imgC"></canvas>
            <canvas id="maskC"></canvas>
        </div>
        <div id="brushCursor"></div>
    </main>

    <div class="toolbar" id="toolbar">
        <div class="tools-row">
            <div class="slider-group">
                <div class="slider-label">BRUSH SIZE <span id="vSize">30px</span></div>
                <input type="range" id="brushSize" min="5" max="150" value="30">
            </div>
            <div class="slider-group">
                <div class="slider-label">HARDNESS <span id="vHard">50%</span></div>
                <input type="range" id="brushHardness" min="0" max="100" value="50">
            </div>
        </div>
        <div class="btn-group">
            <button class="btn-sec btn-icon" id="undoBtn">
                <img src="https://img.icons8.com/ios-filled/50/ffffff/undo.png" class="icon-png">
            </button>
            <button class="btn-danger btn-icon" id="clearBtn">
                <img src="https://img.icons8.com/ios-filled/50/ffffff/trash.png" class="icon-png">
            </button>
            <button class="btn-primary" id="processBtn">
                <img src="https://img.icons8.com/ios-filled/50/ffffff/sparkling.png" class="icon-png">
                Clean Selection
            </button>
            <button class="btn-sec btn-icon" id="compareBtn">
                <img src="https://img.icons8.com/ios-filled/50/ffffff/visible.png" class="icon-png">
            </button>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top: 20px; font-size: 0.8rem; font-weight: bold; letter-spacing: 1px;">OPTIMIZING PIXELS...</div>
    </div>

<script>
    const CONFIG = { maxRes: 2048, passes: 2, searchRadius: 60 };
    const state = { w: 0, h: 0, scale: 1, isDrawing: false, brushSize: 30, hardness: 0.5, history: [], original: null };

    const els = {
        imgC: document.getElementById('imgC'),
        maskC: document.getElementById('maskC'),
        cursor: document.getElementById('brushCursor'),
        toolbar: document.getElementById('toolbar'),
        wrap: document.getElementById('wrap'),
        viewport: document.getElementById('viewport'),
        loader: document.getElementById('loader')
    };

    const ctx = els.imgC.getContext('2d', { willReadFrequently: true });
    const mCtx = els.maskC.getContext('2d');

    // FIXED: Responsive fit logic that prioritizes width to avoid "zoomed out" look
    function fitCanvas() {
        if (!state.w) return;
        const pad = 20; 
        const availableW = els.viewport.clientWidth - pad;
        
        // Scale to fill width, allowing height to determine scrolling
        const zoom = availableW / state.w;
        
        const displayW = state.w * zoom;
        const displayH = state.h * zoom;

        els.wrap.style.width = els.imgC.style.width = els.maskC.style.width = `${displayW}px`;
        els.wrap.style.height = els.imgC.style.height = els.maskC.style.height = `${displayH}px`;
        els.wrap.style.display = 'block';
        
        state.scale = state.w / displayW;
    }

    window.addEventListener('resize', fitCanvas);

    document.getElementById('upload').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                let w = img.width, h = img.height;
                if (w > CONFIG.maxRes || h > CONFIG.maxRes) {
                    const r = Math.min(CONFIG.maxRes / w, CONFIG.maxRes / h);
                    w *= r; h *= r;
                }
                state.w = els.imgC.width = els.maskC.width = Math.round(w);
                state.h = els.imgC.height = els.maskC.height = Math.round(h);
                ctx.drawImage(img, 0, 0, state.w, state.h);
                state.original = ctx.getImageData(0,0,state.w,state.h);
                state.history = [state.original];
                document.getElementById('dropZone').style.display = 'none';
                els.toolbar.style.display = 'flex';
                fitCanvas();
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function getPos(e) {
        const rect = els.imgC.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: (clientX - rect.left) * state.scale,
            y: (clientY - rect.top) * state.scale,
            cx: clientX, cy: clientY
        };
    }

    function handleInput(e) {
        if (!state.w) return;
        const pos = getPos(e);
        const vSize = state.brushSize / state.scale;
        
        els.cursor.style.display = 'block';
        els.cursor.style.width = els.cursor.style.height = `${vSize}px`;
        els.cursor.style.left = `${pos.cx}px`; 
        els.cursor.style.top = `${pos.cy}px`;

        if (state.isDrawing) {
            mCtx.beginPath();
            mCtx.arc(pos.x, pos.y, state.brushSize/2, 0, Math.PI*2);
            const g = mCtx.createRadialGradient(pos.x, pos.y, (state.brushSize/2)*state.hardness, pos.x, pos.y, state.brushSize/2);
            g.addColorStop(0, 'rgba(255, 50, 50, 1)'); 
            g.addColorStop(1, 'rgba(255, 50, 50, 0)');
            mCtx.fillStyle = g;
            mCtx.fill();
        }
    }

    els.maskC.addEventListener('mousedown', (e) => { state.isDrawing = true; handleInput(e); });
    window.addEventListener('mousemove', handleInput);
    window.addEventListener('mouseup', () => state.isDrawing = false);
    els.maskC.addEventListener('touchstart', (e) => { state.isDrawing = true; handleInput(e); }, {passive:false});
    window.addEventListener('touchmove', (e) => { if(state.isDrawing) { e.preventDefault(); handleInput(e); } }, {passive:false});
    window.addEventListener('touchend', () => state.isDrawing = false);

    document.getElementById('brushSize').oninput = (e) => { state.brushSize = +e.target.value; document.getElementById('vSize').innerText = state.brushSize+'px'; };
    document.getElementById('brushHardness').oninput = (e) => { state.hardness = e.target.value/100; document.getElementById('vHard').innerText = e.target.value+'%'; };
    document.getElementById('clearBtn').onclick = () => mCtx.clearRect(0,0,state.w,state.h);
    document.getElementById('undoBtn').onclick = () => { if(state.history.length > 1) { state.history.pop(); ctx.putImageData(state.history[state.history.length-1], 0, 0); mCtx.clearRect(0,0,state.w,state.h); } };
    
    const cmpBtn = document.getElementById('compareBtn');
    cmpBtn.onmousedown = cmpBtn.ontouchstart = () => ctx.putImageData(state.original, 0, 0);
    cmpBtn.onmouseup = cmpBtn.ontouchend = () => ctx.putImageData(state.history[state.history.length-1], 0, 0);
    document.getElementById('saveBtn').onclick = () => { const a = document.createElement('a'); a.href = els.imgC.toDataURL('image/jpeg', 0.95); a.download = 'PhotoShoot_Edit.jpg'; a.click(); };

    document.getElementById('processBtn').onclick = () => {
        els.loader.style.display = 'flex';
        setTimeout(() => {
            for(let p=0; p<CONFIG.passes; p++) runPass();
            state.history.push(ctx.getImageData(0,0,state.w,state.h));
            mCtx.clearRect(0,0,state.w,state.h);
            els.loader.style.display = 'none';
        }, 150);
    };

    function runPass() {
        const imgData = ctx.getImageData(0,0,state.w,state.h);
        const pixels = imgData.data;
        const mask = mCtx.getImageData(0,0,state.w,state.h).data;
        const visited = new Uint8Array(state.w * state.h);
        const queue = [];

        for(let i=0; i<state.w*state.h; i++) {
            if(mask[i*4+3] > 30) visited[i] = 0; else visited[i] = 1;
        }

        for(let i=0; i<state.w*state.h; i++) {
            if(visited[i] === 0) {
                if([1,-1,state.w,-state.w].some(o => visited[i+o] === 1)) queue.push(i);
            }
        }

        let head = 0;
        while(head < queue.length) {
            const p = queue[head++];
            const px = p % state.w, py = Math.floor(p / state.w);
            let bestR, bestG, bestB, bestD = 999999;
            let found = false;

            for(let i=0; i<15; i++) {
                const rx = px + Math.floor((Math.random()-0.5)*CONFIG.searchRadius);
                const ry = py + Math.floor((Math.random()-0.5)*CONFIG.searchRadius);
                if(rx >= 0 && rx < state.w && ry >= 0 && ry < state.h && visited[ry*state.w+rx] === 1) {
                    const s = (ry*state.w+rx)*4;
                    let diff = 0;
                    [1,-1,state.w,-state.w].forEach(o => {
                        if(visited[p+o] === 1) diff += Math.abs(pixels[(p+o)*4] - pixels[(ry*state.w+rx+o)*4]);
                    });
                    if(diff < bestD) { bestD = diff; bestR = pixels[s]; bestG = pixels[s+1]; bestB = pixels[s+2]; found = true; }
                }
            }

            if(found) {
                pixels[p*4] = bestR; pixels[p*4+1] = bestG; pixels[p*4+2] = bestB; pixels[p*4+3] = 255;
                visited[p] = 1;
                [1,-1,state.w,-state.w].forEach(o => {
                    const n = p+o;
                    if(n >= 0 && n < state.w*state.h && visited[n] === 0) { visited[n] = 2; queue.push(n); }
                });
            }
        }
        ctx.putImageData(imgData, 0, 0);
    }
</script>
</body>
</html>
